name: Docker scout

on:
  push:

jobs:
  build:

    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: "gudditi"
          password: "dckr_pat_ndOtbSkfi-5qh4Io2SHgL55THhM"

      # Build and push Docker image with Buildx (don't push on PR)
      # https://github.com/docker/build-push-action
      - name: Build 
        run: docker build -t nodeapp:latest .

      - name: Docker Scout
        id: docker-scout
        uses: docker/scout-action@v1
        with:
          command: quickview,cves,sbom
          image: "nodeapp:latest"
          ignore-unchanged: true
          only-severities: critical,high
          summary: true
          write-comment: false
      # Run Trivy vulnerability scanner and save output to file
      - name: Run Trivy vulnerability scanner
        id: trivy_scan
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: 'nodeapp:latest'
          format: 'table'
          exit-code: '0'
          ignore-unfixed: false
          vuln-type: 'os,library'
          severity: 'HIGH'
          output: './trivy-results.sarif' # Save Trivy output to a file

      - name: Scan image
        uses: anchore/scan-action@v3
        with:
          image: "localbuild/testimage:latest"
          fail-build: false
          output-format: table
          
          
